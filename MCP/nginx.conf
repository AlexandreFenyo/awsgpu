
events {}

http {
upstream ollama_backend {
# Reach Ollama sur l'hôte
server host.docker.internal:8000;  # Sur Windows/Mac, "host.docker.internal" fonctionne;
# sur Linux, ajoute l'hôte via --add-host ou utilise host-gateway.
}

server {
listen 80;
server_name localhost;

# Santé rapide
location /healthz {
  return 200 "OK";
}

# Conversion au vol: /v1/chat/completions -> /api/chat
location /v1/chat/completions {
  rewrite ^/v1/chat/completions(.*)$ /api/chat$1 break;
  proxy_pass http://ollama_backend;
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_read_timeout 3600s;
  proxy_connect_timeout 60s;
}

# Optionnel: copier d'autres chemins /v1 vers /api
location /v1/ {
  rewrite ^/v1/(.*)$ /api/$1 break;
  proxy_pass http://ollama_backend;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

}
}

